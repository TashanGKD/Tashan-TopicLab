name: Deploy

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-${{ github.repository }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          DEPLOY_ENV: ${{ secrets.DEPLOY_ENV }}
          SUBMODULE_TOKEN: ${{ secrets.SUBMODULE_TOKEN }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GITHUB_TOKEN,REPO,DEPLOY_ENV,SUBMODULE_TOKEN
          timeout: 30m
          command_timeout: 30m
          script: |
            set -euo pipefail
            BASE_DIR="${{ secrets.DEPLOY_PATH || '/var/www/github-actions/repos' }}"
            REPO_NAME=$(basename "$REPO")
            REPO_DIR="$BASE_DIR/$REPO_NAME"
            REPO_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"
            if [ ! -d "$REPO_DIR/.git" ]; then
              mkdir -p "$BASE_DIR"
              for i in 1 2 3; do git clone --recurse-submodules "$REPO_URL" "$REPO_DIR" && break || sleep 5; done
            fi
            cd "$REPO_DIR"
            git remote set-url origin "$REPO_URL"
            # Configure submodule URLs before fetch; otherwise fetch uses cached SSH URL and fails
            SUBMODULE_AUTH="${SUBMODULE_TOKEN:-$GITHUB_TOKEN}"
            BACKEND_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/TashanGKD/Resonnet.git"
            git config submodule.backend.url "$BACKEND_URL"
            [ -d .git/modules/backend ] && git config -f .git/modules/backend/config remote.origin.url "$BACKEND_URL"
            for i in 1 2 3; do git fetch origin && break || { [ $i -eq 3 ] && echo "git fetch failed after 3 retries" && exit 1; sleep 5; }; done
            git reset --hard origin/main
            git submodule update --init backend
            git config -f .git/modules/backend/config submodule.skills/assignable_skills/_submodules/ai-research.url "https://x-access-token:${SUBMODULE_AUTH}@github.com/Orchestra-Research/AI-Research-SKILLs.git"
            git config -f .git/modules/backend/config submodule.skills/assignable_skills/_submodules/anthropics.url "https://x-access-token:${SUBMODULE_AUTH}@github.com/anthropics/skills.git"
            git submodule sync --recursive
            git submodule update --init --recursive

            if [ -z "${DEPLOY_ENV:-}" ]; then
              echo "::error::DEPLOY_ENV secret is not set. Add it in repo Settings â†’ Secrets."
              exit 1
            fi
            echo "$DEPLOY_ENV" > .env

            docker compose build --no-cache
            docker compose down
            docker compose up -d
            docker image prune -f

            # Read frontend port from .env (default 3000); trim whitespace/CRLF to avoid nginx config issues
            FRONTEND_PORT=$(grep -E '^FRONTEND_PORT=' .env 2>/dev/null | head -1 | cut -d= -f2- | tr -d ' \r' || echo 3000)

            # Write nginx snippet (location block only, included by tashan.chat server block)
            mkdir -p /etc/nginx/snippets
            printf '%s\n' \
              'location ^~ /topic-lab/ {' \
              "    proxy_pass http://127.0.0.1:${FRONTEND_PORT}/topic-lab/;" \
              '    proxy_set_header Host $host;' \
              '    proxy_set_header X-Real-IP $remote_addr;' \
              '    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
              '    proxy_set_header X-Forwarded-Proto $scheme;' \
              '}' \
              | sudo tee /etc/nginx/snippets/topic-lab.conf > /dev/null
            sudo nginx -t && sudo nginx -s reload

            echo "--------------------------------------------"
            echo "Frontend: http://${{ secrets.DEPLOY_HOST }}/topic-lab"
            echo "Commit:   ${{ github.sha }}"
            echo "--------------------------------------------"